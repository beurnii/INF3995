image: gpol/inf3995

stages:
    - build
    - test
    - lint

cache:
    paths:
        - server/build
        - desktop/build
        - android/build

################
# Build Stages #
################

build-server:
    stage: build
    before_script:
        - mkdir -p server/build
    script:
        - cd server/build && cmake .. && make
    only:
        changes:
            - server/**/*
            - .gitlab-ci.yml

build-server:armv7:
    stage: build
    before_script:
        - mkdir -p server/build
    script:
        - cd server/build && cmake .. -DBUILD_ARMV7=on && make
    only:
        changes:
            - server/**/*
            - .gitlab-ci.yml

build-desktop:
    stage: build
    before_script:
        - update-java-alternatives --set java-1.12.0-openjdk-amd64
    script:
        - cd desktop && gradle build
    only:
        changes:
            - desktop/**/*
            - .gitlab-ci.yml

build-android:
    stage: build
    before_script:
        - update-java-alternatives --set java-1.8.0-openjdk-amd64
    script:
        - cd android && gradle build
    only:
        changes:
            - android/**/*
            - .gitlab-ci.yml

###############
# Test Stages #
###############

test-server:
    stage: test
    script:
        - cd server && echo "TODO"
    only:
        changes:
            - server/**/*
            - .gitlab-ci.yml

test-desktop:
    stage: test
    before_script:
        - update-java-alternatives --set java-1.12.0-openjdk-amd64
    script:
        - cd desktop && gradle test
    only:
        changes:
            - desktop/**/*
            - .gitlab-ci.yml

test-android:
    stage: test
    before_script:
        - update-java-alternatives --set java-1.8.0-openjdk-amd64
    script:
        - cd android && gradle test
    only:
        changes:
            - android/**/*
            - .gitlab-ci.yml

###############
# Lint Stages #
###############

lint-server:
    stage: lint
    script:
        - cd server && chmod +x lint.sh && ./lint.sh tidy && ./lint.sh format
    only:
        changes:
            - server/**/*
            - .gitlab-ci.yml
